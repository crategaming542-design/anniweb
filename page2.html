<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anniversary - Page 2</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;500&display=swap');

    :root{ --pink1:#ffb6c1; --pink2:#ff1744; --pink3:#b30047; }
    *{box-sizing:border-box}
    body{
      margin:0; height:100vh; display:flex; flex-direction:column;
      justify-content:space-between; align-items:center;
      background: linear-gradient(135deg, var(--pink1), var(--pink2), var(--pink3));
      background-size:400% 400%; animation:gradientMove 10s ease infinite;
      font-family:'Poppins',sans-serif; color:white; overflow:hidden;
      opacity:0; transition:opacity 0.6s ease;
    }
    body.fade-in{opacity:1}
    body.fade-out{opacity:0}

    @keyframes gradientMove{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    h1{
      margin-top:30px; font-family:'Great Vibes',cursive;
      font-size:3.5rem;
      background:linear-gradient(90deg,#fff4f8,#ffe1eb,#ffffff);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow:
        0 0 8px rgba(255,180,200,0.8),
        0 0 15px rgba(255,105,135,0.6),
        0 0 25px rgba(255,192,203,0.5);
      letter-spacing:2px;
    }

    .container{flex:1; width:100%; display:flex; align-items:center; justify-content:space-evenly}

    .photo-frame{
      width:300px; height:400px; background:#fff; border-radius:15px;
      box-shadow:0 0 20px rgba(255,105,180,0.45); overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .photo-frame img{width:100%; height:100%; object-fit:cover; display:block}

    .keypad{
      display:grid; grid-template-columns:repeat(3,70px); gap:15px;
      justify-content:center; align-items:center;
    }
    .screen{
      grid-column:span 3; height:50px; background:#fff0f5; border-radius:25px;
      text-align:center; line-height:50px; font-size:1.3rem; color:#ff0066;
      font-weight:700; letter-spacing:2px; overflow:hidden;
      width:100%;
    }
    .btn{
      width:70px; height:70px; background:#ff7aa8; border-radius:50%;
      border:none; color:white; font-size:1.4rem; font-weight:700; cursor:pointer;
      transition:transform .12s ease, background .12s ease; box-shadow:0 4px 10px rgba(0,0,0,.18);
    }
    .btn:hover{transform:scale(1.05); background:#ff99bb}
    footer{margin-bottom:20px; font-style:italic; opacity:.92}

    .heart{position:absolute; color:rgba(255,255,255,.5); font-size:15px; animation:fall linear infinite; top:-10px}
    @keyframes fall{0%{transform:translateY(0) rotate(0); opacity:1} 100%{transform:translateY(100vh) rotate(360deg); opacity:0}}
  </style>
</head>
<body>
  <h1>Happy Anniversary üíñ</h1>

  <div class="container">
    <div class="photo-frame">
      <!-- ·∫£nh n·∫±m c√πng c·∫•p v·ªõi page2.html -->
      <img id="hero" src="./anh1.jpg" alt="·∫¢nh k·ª∑ ni·ªám"
           onerror="this.src='https://via.placeholder.com/300x400/fff0f5/ff7aa8?text=·∫¢nh+kh√¥ng+t√¨m+th·∫•y'">
    </div>

    <div class="keypad" style="width:320px">
      <div class="screen" id="screen"></div>
      <button class="btn" onclick="press('1')">1</button>
      <button class="btn" onclick="press('2')">2</button>
      <button class="btn" onclick="press('3')">3</button>
      <button class="btn" onclick="press('4')">4</button>
      <button class="btn" onclick="press('5')">5</button>
      <button class="btn" onclick="press('6')">6</button>
      <button class="btn" onclick="press('7')">7</button>
      <button class="btn" onclick="press('8')">8</button>
      <button class="btn" onclick="press('9')">9</button>
      <button class="btn" onclick="press('0')">0</button>
      <button class="btn" onclick="clearScreen()">‚å´</button>
      <button class="btn" onclick="submitCode()">‚úî</button>
    </div>
  </div>

  <footer>*M·∫≠t kh·∫©u l√† ng√†y ƒë·∫ßu ti√™n m√¨nh y√™u nhau*</footer>

  <!-- audio (file mp3 n·∫±m trong images/) -->
  <audio id="bgMusic" preload="auto" loop>
    <source src="images/Ch·∫≥ng ph·∫£i ph√©p m√†u v·∫≠y sao ch√∫ng ta g·∫∑p nhau- - Ph√©p M√†u (ƒê√†n C√° G·ªó OST) - MAYDAYs, Minh T·ªëc.mp3" type="audio/mpeg">
  </audio>

  <script>
    // ---- bi·∫øn & h·∫±ng ----
    let code = "";
    const screen = document.getElementById('screen');
    const music = document.getElementById('bgMusic');
    const fadeDuration = 3000; // ms

    // Khi DOM s·∫µn s√†ng
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('fade-in');
      screen.textContent = '';
      createHearts();
    });

    // ƒë·∫£m b·∫£o audio b·∫Øt ƒë·∫ßu khi c√≥ t∆∞∆°ng t√°c ng∆∞·ªùi d√πng (click/tap/pointer)
    function startMusicIfNeeded(){
      if (music && music.paused) {
        music.volume = 1;
        music.play().catch(err => {
          // n·∫øu tr√¨nh duy·ªát ch·∫∑n, s·∫Ω b·∫Øt ƒë·∫ßu khi user t∆∞∆°ng t√°c (submit/press)
          console.log('Kh√¥ng th·ªÉ autoplay ngay:', err);
        });
      }
    }
    // d√πng m·ªôt l·∫ßn khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c l·∫ßn ƒë·∫ßu ti√™n tr√™n body
    const startHandler = () => { startMusicIfNeeded(); document.body.removeEventListener('pointerdown', startHandler); };
    document.body.addEventListener('pointerdown', startHandler, {passive:true});

    // H√†m nh·∫≠p m·∫≠t m√£
    function press(num){
      if (code.length < 8) {
        code += num;
        screen.textContent = formatDate(code);
      }
    }
    function clearScreen(){
      code = '';
      screen.textContent = '';
    }
    function formatDate(s){
      if (s.length <= 2) return s;
      if (s.length <= 4) return s.slice(0,2) + '/' + s.slice(2);
      if (s.length <= 8) return s.slice(0,2) + '/' + s.slice(2,4) + '/' + s.slice(4);
      return s;
    }

    // Fade out m∆∞·ª£t b·∫±ng requestAnimationFrame -> pause -> redirect
    function fadeOutAndRedirect(callbackUrl){
      if (!music || music.paused) {
        // n·∫øu nh·∫°c ch∆∞a ch·∫°y th√¨ redirect ngay
        window.location.href = callbackUrl;
        return;
      }

      const startVol = (typeof music.volume === 'number') ? music.volume : 1;
      const startTime = performance.now();

      function step(now){
        const elapsed = now - startTime;
        const t = Math.min(1, elapsed / fadeDuration);
        const newVol = startVol * (1 - t);
        music.volume = Math.max(0, newVol);

        if (t < 1){
          requestAnimationFrame(step);
        } else {
          try { music.pause(); } catch(e){ console.warn(e); }
          // ƒë·∫£m b·∫£o redirect ngay sau khi d·ª´ng
          window.location.href = callbackUrl;
        }
      }
      requestAnimationFrame(step);

      // fallback: n·∫øu v√¨ l√Ω do n√†o ƒë√≥ redirect kh√¥ng x·∫£y ra, √©p redirect sau fadeDuration + 1000ms
      setTimeout(() => {
        if (location.pathname.indexOf(callbackUrl) === -1) {
          window.location.href = callbackUrl;
        }
      }, fadeDuration + 1000);
    }

    // X·ª≠ l√Ω submit
    function submitCode(){
      // ƒë·∫£m b·∫£o music ƒë√£ ƒë∆∞·ª£c b·∫≠t √≠t nh·∫•t 1 l·∫ßn (n·∫øu ng∆∞·ªùi d√πng b·∫•m submit th√¨ coi l√† interaction)
      startMusicIfNeeded();

      if (code === '01112021') {
        // fade v√† chuy·ªÉn sang locked.html
        fadeOutAndRedirect('locked.html');
      } else {
        alert('Sai r·ªìi, th·ª≠ l·∫°i nh√© üíï');
        clearScreen();
      }
    }

    // Hi·ªáu ·ª©ng tr√°i tim r∆°i
    function createHearts(){
      const heartCount = 16;
      for (let i = 0; i < heartCount; i++){
        const h = document.createElement('div');
        h.className = 'heart';
        h.innerText = 'üíñ';
        h.style.left = (Math.random()*100) + 'vw';
        h.style.fontSize = (12 + Math.random()*18) + 'px';
        h.style.animationDuration = (4 + Math.random()*3) + 's';
        document.body.appendChild(h);
        h.addEventListener('animationend', () => h.remove());
      }
      // ti·∫øp t·ª•c t·∫°o theo chu k·ª≥ nh·ªè
      setTimeout(createHearts, 900);
    }
  </script>
</body>
</html>
